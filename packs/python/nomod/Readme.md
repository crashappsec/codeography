# About

This is a set of codeql queries to detect hotspots in code, such as cryptographic operations.
It can be combined with other github actions

# Developing

Set up [vscode-codeql-starter](https://github.com/github/vscode-codeql-starter) and add the directory with the pack you are interested in 
the top level folder 

# Publishing the pack

To publish the pack in [our registry](https://github.com/orgs/crashappsec/packages) you need to first create a personal access token with write permissions ([see here](https://www.notion.so/GitHub-Container-Registry-b0f0411a6c944d9b93e031c11299f4c4) for a guide).

Once you have a token you can issue `codeql pack publish --github-auth-stdin` and pass the token in the prompt.


# Using the pack in a github action 

One can use the above pack as part of a github following the CodeQL documentation.
Since the bqrs files generated by the pack do not necessarily constitute reportable issues,
one can access the raw results to compare changes across PRs. For instance, the 
action below, checks if a transitive call to a crypto library has changed in a given
PR and adds a secondary reviewer if so:

```yaml

name: "CodeQL"

on:
  push:
    branches: [ "main" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main" ]
  schedule:
    - cron: '30 3 * * 3'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      id: init
      with:
        packs: nettrino/nomod
        languages: ${{ matrix.language }}

    - name: Print CodeQL Version
      run: ${{steps.init.outputs.codeql-path}} version --format=json
        
    - name: Autobuild
      uses: github/codeql-action/autobuild@v2


    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"

    - name: Copy previous analysis results
      run: cp /home/runner/work/_temp/codeql_databases/python/results/nettrino/nomod/transitive.bqrs /tmp/transitive.bqrs
    
    - name: Checkout previous commit
      run: git checkout HEAD~1
    
    - name: Re-Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        packs: crashappsec/nomod
        db-location: /tmp/newdb_loc
        languages: ${{ matrix.language }}
    
    - name: Perform CodeQL Analysis on previous state
      uses: github/codeql-action/analyze@v2
      with:
        category: "previous_commit"

    - name: Upload original analysis file
      uses: actions/upload-artifact@v3
      with:
        name: latest-transitive
        path: /tmp/transitive.bqrs
    
    - name: Upload new analysis file
      uses: actions/upload-artifact@v3
      with:
        name: previous-transitive
        path: /tmp/newdb_loc/python/results/nettrino/nomod/transitive.bqrs 


    - name: See if there's a diff
      run: |
        ${{steps.init.outputs.codeql-path}} bqrs decode /tmp/newdb_loc/python/results/nettrino/nomod/transitive.bqrs  > /tmp/old.csv 
        ${{steps.init.outputs.codeql-path}} bqrs decode /tmp/transitive.bqrs > /tmp/new.csv

    - name: assign reviewer
      uses: LongOddCode/assign-reviewer@0.2.2
      with:
        #github access token.
        token: ${{ secrets.REVIEWER_TOKEN }}

        reviewers: '["<secondary_reviewer_id>"]'

        conscript: 0

        script: bash

        result: TELEMETRY_RESULT

        run: |
          if ! diff -q /tmp/old.csv /tmp/new.csv; then
            echo '::set-output name=TELEMETRY_RESULT::true'
          fi

```
